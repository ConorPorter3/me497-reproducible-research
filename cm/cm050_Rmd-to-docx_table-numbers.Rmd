---
output: github_document
--- 

```{r echo = FALSE}
library(knitr)
opts_knit$set(root.dir = "../")
opts_chunk$set(echo = TRUE, results = 'hide')
```

```{r echo = FALSE}
source("cm/helper_02_icons.R")
```

# Rmd to docx: numbering tables and figures

As Norbert K&ouml;hler says, "R Markdown has no native method to number and reference table and figure captions". The `captioner` packages gives us a method  for auto-numbering figures and tables and automatically updating the in-text reference numbers  as well. 

This tutorial is adapted from Norbert's blog post plus Andrew Dolman's comments on that post. 

When complete, your output document should be a 2-page docx file with two tables and two figures with automatically-generated table and figure numbers. 

## install 

- Install the `captioner` package 
- Install the `devtools` package 
- In your Console: `devtools::install_github('yihui/knitr', build_vignettes = TRUE)` 

The purpose of last line above is to install the latest development version of `knitr` so we can take advantage of the knitr option `row.names = FALSE` when using `kable()` to print a table. Plus we get recent bug fixes. 

## practiceR 

- Launch your `practiceR` project 
- Open a new Rmd file. Mine is called `test-captioner.Rmd`. 
- Both `word_document` and `html_document` can be used in the YAML header.  
- For `pdf_document`, see the references for additional lines needed. 

```
---
title: "Testing *captioner*"
author: "Richard Layton"
date: "2016-10-29"
output:
  word_document:
    fig_caption: yes
---
```


`r code_icon` Start with the usual setup.
```
# initialize knitr
library(knitr)
opts_knit$set(root.dir = "../")
opts_chunk$set(echo = TRUE)
```

`r code_icon` Load packages. The `splines` package is part of the base R installation, used later for a spline curve fit. 
```{r}
# packages 
library(captioner)
library(ggplot2)
library(splines)
```

### assign prefixes 

We assign the prefixes we want to use for Tables and Figures. I've used "Table" and "Figure". Some publications might expect you to abbreviate, e.g., "Tab." or "Fig.".

`r code_icon`  

<pre><code>```{r, results = 'hide'}
# assign table and figure prefixes 
table_nums  <- captioner(prefix = "Table")
figure_nums <- captioner(prefix = "Figure")
<code>```</code>
</code></pre>

- `captioner()` function assigns the table and figure caption prefixes  
- `results = 'hide'` is a knitr option to suppress an unnecessary printout  
- Knit your document 

```{r results = 'hide', echo = FALSE}
# assign table and figure prefixes 
table_nums  <- captioner(prefix = "Table")
figure_nums <- captioner(prefix = "Figure")
```

## tables 

Start a new section in the output document. 

`r text_icon`
```
# Tables 
```

First, we write a code chunk that creates a caption and assigns it a name. The name is used later as a reference-ID to add the caption to the table  and to make an in-line references to the table.  

`r code_icon` 
```{r results = 'hide'}
# you may assign your own name and caption 
table_nums(name = "a_table", caption = "A descriptive caption for the table.")
```

Use the caption number in an inline reference.

`r text_icon`

<pre><code>In this sentence, I use an inline reference to 
<code>`</code>r table_nums(name = "a_table",  display = "cite")<code>`</code>. 
The table follows.
</code></pre>

The arguments for `table_nums()` include: 

- `name = "a_table"` identifies the table we're citing 
- `"display = full"` shows the entire caption with prefix and number 
- `"display = cite "` displays just the prefix and number, without the caption 
- `"display = num"` displays just the number 

Use the caption and print the table.

`r code_icon`
```{r}
# print the table with the caption assigned by its ID
kable(head(cars), caption = table_nums("a_table"), row.names = FALSE)
```

When using `kable()` to print a table 

- the `row.names = FALSE` argument only works if you've installed the development version of knitr 
- the `caption = table_nums()` argument is how we assign the caption generated by `captioner`  

Create a caption for a second table. 

`r code_icon`
```{r results = 'hide'}
# create a second table caption 
table_nums("another_table", "A boring table.")
```

Use the caption number in an inline reference. 

`r text_icon`

<pre><code>But the results in 
<code>`</code>r table_nums(name = "another_table",  display = "cite")<code>`</code> 
are not as interesting. 
</code></pre>

Use the caption and print the second table. The tables are automatically numbered in sequence. 

`r code_icon`
```{r}
kable(tail(cars), caption = table_nums("another_table"), row.names = FALSE)
```

Once the table has been identified, it can be referred to as many times as needed. The inline R code will insert the correct table number. 

`r text_icon`

<pre><code>Well, maybe the results in  
<code>`</code>r table_nums(name = "another_table",  display = "cite")<code>`</code> 
are not as boring as we thought.
</code></pre>


## figures 

Start a new section in the output document. 

`r text_icon`
```
# Figures 
```

Create a table caption. 

`r code_icon`
```{r results = 'hide'}
figure_nums(name = "one_figure", 
	caption = "An auto-numbered figure caption that is part of the figure image.")
```

Refer to it by number in an inline reference. 

`r text_icon`

<pre><code>This sentence allows me to insert an inline reference to  
<code>`</code>r figure_nums("one_figure",  display = "cite")<code>`</code>.
</code></pre>

Create the figure. Note that the caption function call a `knitr` argument in the code chunk header: 

- `fig.cap` is a knitr argument for assigning our caption 
- `fig.height` is a knitr argument in inches 
  

`r code_icon`

<pre><code>```{r fig.cap = figure_nums("one_figure"), fig.height = 3}
ggplot(data = cars, aes(x = speed, y = dist)) + 
	geom_point() + 
	geom_smooth(method = "lm", formula = y ~ bs(x, 3), se = FALSE)
<code>```</code>
</code></pre>

Regarding the spline curve fit: 

- `bs()` is a polynomial B-spline from the `splines` package 
- For a complete list of spline functions, use `library(help = "splines")` 

```{r fig.cap = figure_nums("one_figure"), fig.height = 3, echo = FALSE}
ggplot(data = cars, aes(x = speed, y = dist)) + 
	geom_point() + 
	geom_smooth(method = "lm", formula = y ~ bs(x, 3), se = FALSE)
```



Create a new caption. 

`r code_icon`
```{r results = 'hide'}
figure_nums("another_figure", "Same data with a linear fit.")
```

Another inline reference. 

`r text_icon`

<pre><code>If we do the same graph with a linear fit, we get  
<code>`</code>r figure_nums("another_figure",  display = "cite")<code>`</code>.
</code></pre>

And a new graph. 

`r code_icon`

<pre><code>```{r fig.cap = figure_nums("another_figure"), fig.height = 3}
ggplot(data = cars, aes(x = speed, y = dist)) + 
	geom_point() + 
	geom_smooth(method = "lm", se = FALSE)
<code>```</code>
</code></pre>

```{r fig.cap = figure_nums("another_figure"), fig.height = 3, echo = FALSE}
ggplot(data = cars, aes(x = speed, y = dist)) + 
	geom_point() + 
	geom_smooth(method = "lm", se = FALSE)
```

`r text_icon`

<pre><code>So there we are. Anywhere in the document we can refer back to  
<code>`</code>r table_nums("a_table",  display = "cite")<code>`</code>, 
<code>`</code>r table_nums("another_table",  display = "cite")<code>`</code>, 
<code>`</code>r figure_nums("one_figure",  display = "cite")<code>`</code>, or 
<code>`</code>r figure_nums("another_figure",  display = "cite"<code>`</code>.
</code></pre>


If the tables or figures are added or deleted, all numbers will automatically update. 


## final thoughts

Norbert KÃ¶hler, in his write-up, collects all the captions in a single code chunk at the top of the script. I prefer to create the captions at the point in the script where I create the table of graph. Your mileage may vary. 

## references

1. Norbert K&ouml;hler (2016-10-22) [R Markdown: How to number and reference tables](http://datascienceplus.com/r-markdown-how-to-number-and-reference-tables/) 
2. Andrew Dolman (2016) [Testing captioner](https://onedrive.live.com/?authkey=%21AApYWBGHNR06Y5I&cid=FCFCD3FD042AF7F1&id=FCFCD3FD042AF7F1%2118306&parId=FCFCD3FD042AF7F1%21322&action=locate) from the comments section of Norbert's blog post. 


--- 
[main page](../README.md)
